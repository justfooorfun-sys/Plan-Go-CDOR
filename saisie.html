<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CDOR – Saisie (planning dialyse)</title>
  <style>
    :root{ --bleu:#2e3e56; --bleu-clair:#5b7898; --orange:#f09b2d; --gris:#f4f6f9; --texte:#0f172a }
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--gris);color:var(--texte)}
    .wrap{max-width:1100px;margin:24px auto;padding:20px}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fff,rgba(255,255,255,.95));border-bottom:1px solid #e5e7eb}
    .head-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:48px;width:auto;border-radius:6px;display:block}
    .brand img[hidden]{display:none}
    .brand h1{font-size:32px;margin:0;color:var(--bleu);letter-spacing:.2px}
    .head-right{display:flex;flex-direction:column;align-items:flex-end}
    .clock{font-variant-numeric:tabular-nums;font-weight:800;color:var(--bleu);font-size:32px;line-height:1}
    .lastsave{font-size:13px;color:#64748b;margin-top:4px}

    .note{background:#fff;border:1px solid #e5e7eb;border-left:6px solid var(--orange);padding:18px 18px;border-radius:12px;margin:18px 0}
    .note p{margin:0;font-size:18px;line-height:1.5}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.04)}
    .toolbar{display:flex;align-items:center;justify-content:flex-end;gap:12px;padding:14px 16px;border-bottom:1px dashed #e5e7eb}
    .toolbar button{appearance:none;border:0;background:var(--bleu);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .toolbar button.secondary{background:#eef2f7;color:var(--bleu)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:12px}
    thead th{font-size:12px;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.08em}
    tbody tr{background:#fcfdff;border:1px solid #e5e7eb}
    tbody tr td{padding:10px}
    tbody tr:first-child td{border-top-left-radius:12px;border-top-right-radius:12px}
    tbody tr:last-child td{border-bottom-left-radius:12px;border-bottom-right-radius:12px}

    .place{font-weight:800;color:var(--bleu)}
    input[type="time"], select{width:100%;padding:8px 10px;border:1px solid #d0d7e2;border-radius:10px;background:#fff;font-size:14px}
    .end-chip{display:inline-block;padding:8px 10px;border-radius:10px;background:rgba(240,155,45,.08);color:#a15f00;font-weight:800;font-variant-numeric:tabular-nums}
    .manual{display:flex;gap:8px;align-items:center;margin-top:6px}
    .manual label{font-size:12px;color:#64748b}

    .footer{padding:16px;color:#64748b;font-size:13px}

    @media (max-width:760px){
      .brand h1{font-size:24px}
      .clock{font-size:26px}
      thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tbody tr{margin:10px 0;border-radius:12px}
      td{border-bottom:1px dashed #eef2f7}
      td:last-child{border-bottom:0}
      .label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px;text-transform:uppercase}
    }
  </style>
</head>
<body>
  <!-- UNIQUE HEADER ICI, PAS DE COPIE EN BAS -->
  <header>
    <div class="head-inner">
      <div class="brand">
        <img id="logo" alt="CDOR" src="logo.jpg" onerror="this.hidden=true" />
        <h1>CDOR – Saisie du planning (dialyse)</h1>
      </div>
      <div class="head-right">
        <div class="clock" id="clock">--:--</div>
        <div class="lastsave" id="lastsave">Dernière sauvegarde : —</div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="note">
      <p><strong>But :</strong> renseigner l’heure de branchement et la durée de dialyse par place.<br>
      L’<em>heure de fin</em> est calculée automatiquement (durée + <strong>15 min</strong>) mais peut être <strong>ajustée manuellement</strong> si besoin.</p>
    </section>

    <div class="card">
      <div class="toolbar">
        <button id="btnReset" class="secondary" title="Effacer toutes les valeurs">Réinitialiser</button>
        <button id="btnSave" title="Sauvegarder maintenant">Sauvegarder</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Place</th>
            <th>Heure de branchement</th>
            <th>Temps de dialyse</th>
            <th>Heure de fin</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footer">
        <span>Les données sont stockées localement dans ce navigateur (localStorage).</span>
      </div>
    </div>
  </div>

  <script>
    const PLACES = ["1-1","1-2","1-3","1-4","2-1","2-2","2-3","2-4","3-1","3-2","3-3","3-4","4-1","4-2"];
    const STORAGE_KEY = 'cdr_planning_v1';

    const formatTime = dt => dt.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    function tick(){ document.getElementById('clock').textContent = formatTime(new Date()); }
    setInterval(tick, 1000); tick();

    function updateLastSavedUI(ts){
      const el = document.getElementById('lastsave');
      if(!ts){ el.textContent = 'Dernière sauvegarde : —'; return; }
      try{
        const d = new Date(ts);
        el.textContent = 'Dernière sauvegarde : ' + d.toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      }catch(e){ el.textContent = 'Dernière sauvegarde : —'; }
    }

    function minutesFromDurationVal(val){ return parseInt(val||'0',10) || 0; }
    function optionDur(mins,label){ return `<option value="${mins}">${label}</option>`; }

    function buildRow(place, saved){
      const tr = document.createElement('tr');

      // place
      const tdPlace = document.createElement('td');
      tdPlace.className = 'place';
      tdPlace.textContent = place;

      // start time
      const tdStart = document.createElement('td');
      const startLabel = document.createElement('span'); startLabel.className='label'; startLabel.textContent='Heure de branchement';
      const start = document.createElement('input'); start.type='time'; start.step='60'; start.value = saved?.start || '';
      tdStart.append(startLabel,start);

      // duration (tous les 15 min de 2h à 4h)
      const tdDur = document.createElement('td');
      const durLabel = document.createElement('span'); durLabel.className='label'; durLabel.textContent='Temps de dialyse';
      const sel = document.createElement('select');
      let html = `<option value="">—</option>`;
      const steps = [120,135,150,165,180,195,210,225,240];
      const labels = ['2h','2h15','2h30','2h45','3h','3h15','3h30','3h45','4h'];
      steps.forEach((m,i)=>{ html += optionDur(m, labels[i]); });
      sel.innerHTML = html;
      if(saved?.dur){ sel.value = saved.dur; }
      tdDur.append(durLabel, sel);

      // end (auto + saisie libre)
      const tdEnd = document.createElement('td');
      const endLabel = document.createElement('span'); endLabel.className='label'; endLabel.textContent='Heure de fin';
      const endChip = document.createElement('span'); endChip.className='end-chip'; endChip.textContent='—';
      const manualWrap = document.createElement('div'); manualWrap.className='manual';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id = `cb-${place}`;
      const lbl = document.createElement('label'); lbl.setAttribute('for', cb.id); lbl.textContent = 'Saisie manuelle';
      const manual = document.createElement('input'); manual.type='time'; manual.step='60'; manual.disabled = true;
      manualWrap.append(cb,lbl,manual);
      tdEnd.append(endLabel, endChip, manualWrap);

      tr.append(tdPlace, tdStart, tdDur, tdEnd);

      function recalc(){
        if(cb.checked && manual.value){ endChip.textContent = manual.value; return; }
        const s = start.value; const d = minutesFromDurationVal(sel.value);
        if(!s || !d){ endChip.textContent='—'; return; }
        const [H,M] = s.split(':').map(Number);
        const t = new Date(); t.setHours(H,M,0,0);
        t.setMinutes(t.getMinutes() + d + 15); // +15 min marge
        endChip.textContent = formatTime(t);
      }

      // Restaurer état
      if(saved?.endIsManual){ cb.checked = true; manual.disabled = false; }
      if(saved?.endManual){ manual.value = saved.endManual; }
      recalc();

      // Events
      start.addEventListener('change', ()=>{recalc(); autosave();});
      sel.addEventListener('change',   ()=>{recalc(); autosave();});
      cb.addEventListener('change',    ()=>{ manual.disabled = !cb.checked; recalc(); autosave(); });
      manual.addEventListener('change',()=>{ recalc(); autosave(); });

      tr.dataset.place = place;
      tr.getValue = ()=>({ place, start: start.value, dur: sel.value, endIsManual: cb.checked, endManual: manual.value });
      return tr;
    }

    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(e){ return {}; } }
    function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function autosave(){
      const rows = [...document.querySelectorAll('#tbody tr')];
      const payload = {};
      rows.forEach(tr=>{ payload[tr.dataset.place] = tr.getValue(); });
      payload._lastSaved = new Date().toISOString();
      save(payload);
      updateLastSavedUI(payload._lastSaved);
    }

    function populate(){
      const saved = load();
      const tbody = document.getElementById('tbody');
      tbody.innerHTML='';
      PLACES.forEach(p=>{ tbody.appendChild( buildRow(p, saved[p]) ); });
      updateLastSavedUI(saved?._lastSaved);
    }

    document.getElementById('btnReset').addEventListener('click', ()=>{
      if(confirm('Effacer toutes les valeurs ?')){ localStorage.removeItem(STORAGE_KEY); populate(); }
    });
    document.getElementById('btnSave').addEventListener('click', ()=>{ autosave(); });

    populate();
  </script>
</body>
</html>
